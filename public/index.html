<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mission Compass — なぜ学ぶのか、を決めよう。</title>
  <meta name="theme-color" content="#0B3D60">
  <style>
    :root{
      --cream:#F7F1E6; --cream-2:#F4EBDC; --white:#FFFFFF;
      --dark-blue:#0B3D60; --royal:#4169E1;
      --olive:#6B8E23; --burnt:#CC5A1E; --purple:#4B2E83;
      --charcoal:#3B4044; --ink:#1F2937;
      --max:1000px;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; background:var(--cream); color:#222;
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",Arial,sans-serif;
    }

    /* Header */
    header{
      position:sticky; top:0; z-index:1000;
      backdrop-filter:saturate(180%) blur(8px);
      background:linear-gradient(180deg,rgba(255,255,255,.96),rgba(255,255,255,.78));
      border-bottom:1px solid rgba(59,64,68,.16);
    }
    .nav{max-width:var(--max); margin:0 auto; padding:12px 14px; display:flex; align-items:center; gap:12px;}
    .brand{display:flex; align-items:center; gap:10px; color:var(--dark-blue); font-weight:900; letter-spacing:.3px}
    .mark{width:28px;height:28px;border-radius:50%;background:var(--dark-blue);display:grid;place-items:center;color:#fff;font-size:16px;box-shadow:0 2px 6px rgba(0,0,0,.15)}
    .nav-actions{margin-left:auto; display:flex; gap:10px; align-items:center}
    .btn{appearance:none; border:0; border-radius:12px; padding:10px 16px; font-weight:800; cursor:pointer}
    .btn[disabled]{opacity:.5; cursor:not-allowed}
    .btn-outline{background:#fff; color:var(--dark-blue); border:1px solid rgba(59,64,68,.22)}
    .btn-primary{
      background:linear-gradient(180deg, var(--royal), #3a5fd0); color:#fff;
      box-shadow:0 10px 24px rgba(65,105,225,.30), inset 0 1px 0 rgba(255,255,255,.28);
      border:1px solid rgba(65,105,225,.55);
    }
    .user{font-size:12px; color:#444}

    /* Hero */
    .bleed-tight{ margin-left:calc(50% - 50vw); margin-right:calc(50% - 50vw); width:100vw; }
    .hero-rotator{ position:relative; width:100%; height:clamp(420px, 88vh, 1000px); background:#000; overflow:hidden; }
    @supports (height: 88dvh){ .hero-rotator{ height:clamp(420px, 88dvh, 1000px); } }
    .hero-rotator .slide{ position:absolute; inset:0; opacity:0; transition:opacity .6s ease; }
    .hero-rotator .slide.on{ opacity:1; }
    .hero-rotator .slide img{ width:100%; height:100%; object-fit:cover; display:block; transform:scale(1) translate3d(0,0,0) }
    .slide.on img{ animation:kb-center 4.5s ease-in-out both; }
    .slide.kb-tl.on img{ animation-name:kb-tl } .slide.kb-tr.on img{ animation-name:kb-tr }
    .slide.kb-bl.on img{ animation-name:kb-bl } .slide.kb-br.on img{ animation-name:kb-br }
    @keyframes kb-center{ from{transform:scale(1.05)} to{transform:scale(1)} }
    @keyframes kb-tl{ from{transform:scale(1.05) translate3d(.8%, .8%,0)} to{transform:scale(1) translate3d(0,0,0)} }
    @keyframes kb-tr{ from{transform:scale(1.05) translate3d(-.8%, .8%,0)} to{transform:scale(1) translate3d(0,0,0)} }
    @keyframes kb-bl{ from{transform:scale(1.05) translate3d(.8%,-.8%,0)} to{transform:scale(1) translate3d(0,0,0)} }
    @keyframes kb-br{ from{transform:scale(1.05) translate3d(-.8%,-.8%,0)} to{transform:scale(1) translate3d(0,0,0)} }
    .hero-rotator .cap{
      position:absolute; color:#fff; font-weight:800;
      font-size:clamp(18px, 3.6vw, 26px);
      text-shadow:0 2px 10px rgba(0,0,0,.45), 0 6px 22px rgba(0,0,0,.28);
      opacity:0; transform:translateY(6px);
    }
    .slide.on .cap{ animation:capIn .5s cubic-bezier(.25,.7,.25,1) .08s both; }
    @keyframes capIn{ from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:none} }
    .cap.tl{ top:7%; left:5% } .cap.tr{ top:7%; right:5%; text-align:right }
    .cap.bl{ bottom:7%; left:5% } .cap.br{ bottom:7%; right:5%; text-align:right }
    .cap.c{ top:50%; left:50%; transform:translate(-50%,-50%); text-align:center }
    .dots{ position:absolute; left:0; right:0; bottom:12px; display:flex; justify-content:center; gap:6px; pointer-events:none; }
    .dot{ width:6px; height:6px; border-radius:999px; background:rgba(255,255,255,.6) }
    .dot.on{ background:#fff }

    /* CTA */
    main{max-width:var(--max); margin:0 auto; padding:0 14px}
    .cta-wrap{ padding:22px 0 8px; }
    .cta-wrap h1{ color:var(--dark-blue); font-size:clamp(22px, 6.2vw, 34px); line-height:1.25; margin:0 0 10px; font-weight:900; }
    .cta-wrap .lead{ color:#48505A; margin:0 0 16px; font-size:clamp(15px, 3.8vw, 17px); }
    .cta-btn{
      --royal:#4169E1;
      display:inline-flex; align-items:center; justify-content:center;
      width:100%; max-width:520px;
      padding:20px 24px; font-size:18px; font-weight:900;
      background:linear-gradient(180deg, var(--royal), #3a5fd0);
      color:#fff; border:1px solid rgba(65,105,225,.55);
      border-radius:18px; cursor:pointer;
      box-shadow:0 18px 36px rgba(65,105,225,.35), 0 10px 22px rgba(11,42,107,.14);
      transition:transform .12s ease, box-shadow .12s ease, filter .12s ease;
      text-decoration:none;
    }
    .cta-btn:hover{ transform:translateY(-1px) }
    .cta-meta{ margin-top:12px; display:flex; gap:8px; flex-wrap:wrap; }
    .badge{ display:inline-flex; align-items:center; gap:6px; padding:8px 10px; background:var(--white); border:1px solid rgba(59,64,68,.22); border-radius:999px; font-size:12px; color:var(--ink); }
    .badge svg{ width:14px; height:14px; color:var(--dark-blue); }

    /* Why（色分け） */
    .why{ padding:28px 0 8px; }
    .why h2{ color:var(--dark-blue); font-size:clamp(20px, 5.4vw, 28px); font-weight:800; margin:0 0 10px; }
    .why .sub{ color:#60656B; margin:0 0 18px; font-size:clamp(14px, 3.6vw, 16px); }
    .why-grid{ display:grid; gap:12px; grid-template-columns:1fr; }
    @media (min-width:720px){ .why-grid{ grid-template-columns:repeat(3,1fr); gap:14px } }
    .why-card{ padding:16px; border-radius:16px; background:#fff; border:1px solid rgba(59,64,68,.16); box-shadow:0 8px 24px rgba(2,8,20,.04); color:#1b1b1b; }
    .why-ic{ width:40px; height:40px; border-radius:12px; display:inline-flex; align-items:center; justify-content:center; margin-bottom:10px; color:#fff; }
    .why-ttl{ font-weight:800; margin:0 0 6px; font-size:16px; color:var(--ink); }
    .why-txt{ margin:0; color:#374151; font-size:14px; line-height:1.6; }
    .why-badge{ display:inline-block; margin-top:10px; font-size:12px; font-weight:700; padding:4px 8px; border-radius:999px; }
    .why-card.olive  { border-color: rgba(107,142,35,.35);  background:linear-gradient(180deg,#fff,#F6F8EC) }
    .why-card.burnt  { border-color: rgba(204,90,30,.35);   background:linear-gradient(180deg,#fff,#FBF1EA) }
    .why-card.purple { border-color: rgba(75,46,131,.35);   background:linear-gradient(180deg,#fff,#F3EEF9) }
    .why-card.olive  .why-ic{ background:var(--olive) }
    .why-card.burnt  .why-ic{ background:var(--burnt) }
    .why-card.purple .why-ic{ background:var(--purple) }
    .why-card.olive  .why-badge{ color:var(--olive);  background:rgba(107,142,35,.10);  border:1px solid rgba(107,142,35,.25) }
    .why-card.burnt  .why-badge{ color:var(--burnt);  background:rgba(204,90,30,.10);   border:1px solid rgba(204,90,30,.25) }
    .why-card.purple .why-badge{ color:var(--purple); background:rgba(75,46,131,.10);  border:1px solid rgba(75,46,131,.25) }

    /* Mini Try */
    .mini{ margin:28px 0 10px; padding:16px; border:1px solid rgba(59,64,68,.16); border-radius:16px; background:#fff; box-shadow:0 8px 24px rgba(2,8,20,.04);}
    .mini h2{ margin:0 0 8px; font-size:18px; color:var(--dark-blue); font-weight:900; }
    .mini p{ margin:0 0 12px; color:#48505A; font-size:14px; }
    .steps{ display:grid; gap:10px; }
    .step{ border:1px dashed rgba(59,64,68,.20); border-radius:12px; padding:12px; }
    .step h3{ margin:0 0 8px; font-size:14px; color:#222; }
    .chips{ display:flex; flex-wrap:wrap; gap:8px; }
    .chip{ appearance:none; border:1px solid rgba(65,105,225,.28); background:#eef3ff; color:#1b1b1b; border-radius:999px; padding:8px 10px; font-weight:800; cursor:pointer; }
    .chip[aria-pressed="true"]{ background:#dfe7ff; border-color:rgba(65,105,225,.55); }
    .mini .actions{ display:flex; gap:10px; margin-top:12px; }
    .mini .cta{ flex:1; display:inline-flex; align-items:center; justify-content:center; padding:14px 16px; border-radius:12px; font-weight:900; border:1px solid rgba(65,105,225,.55); background:linear-gradient(180deg, var(--royal), #3a5fd0); color:#fff; cursor:pointer; }
    .mini .note{ font-size:12px; color:#666; margin-top:6px; }

    footer{padding:26px 14px 40px; text-align:center; color:#666; font-size:12px}
    .build{ margin-top:6px; color:#8A92A2; font-size:11px; user-select:text; }
  </style>
</head>
<body>
  <header>
    <nav class="nav">
      <div class="brand"><span class="mark">✦</span>Mission Compass</div>
      <div class="nav-actions">
        <span id="user" class="user" hidden></span>
        <button id="loginBtn"  class="btn btn-outline" type="button">Googleでログイン</button>
        <button id="logoutBtn" class="btn btn-primary" type="button" hidden>ログアウト</button>
      </div>
    </nav>
  </header>

  <!-- Hero -->
  <div class="bleed-tight">
    <div class="hero-rotator" id="heroRotator" aria-label="インスピレーション写真">
      <figure class="slide kb-tl on">
        <img src="https://images.unsplash.com/photo-1492684223066-81342ee5ff30?auto=format&fit=crop&w=1600&q=80" alt="紙吹雪が舞う大規模ライブの熱狂" width="1600" height="900" loading="eager" />
        <figcaption class="cap tl">スポットライトは、あなたへ。</figcaption>
      </figure>
      <figure class="slide kb-br">
        <img src="https://images.unsplash.com/photo-1470225620780-dba8ba36b745?auto=format&fit=crop&w=1600&q=80" alt="強い照明の中で歌うシンガー" width="1600" height="900" loading="lazy" />
        <figcaption class="cap br">一歩、光の中へ。</figcaption>
      </figure>
      <figure class="slide">
        <img src="https://images.unsplash.com/photo-1529070538774-1843cb3265df?auto=format&fit=crop&w=1600&q=80" alt="飛行機の窓から見る夕焼け" width="1600" height="900" loading="lazy" />
        <figcaption class="cap c">次の目的地は、世界。</figcaption>
      </figure>
      <figure class="slide kb-tr">
        <img src="https://images.unsplash.com/photo-1469474968028-56623f02e42e?auto=format&fit=crop&w=1600&q=80" alt="花火が上がる都市の夜景" width="1600" height="900" loading="lazy" />
        <figcaption class="cap tr">努力は、必ず祝われる。</figcaption>
      </figure>
      <figure class="slide kb-bl">
        <img src="https://images.pexels.com/photos/1571460/pexels-photo-1571460.jpeg?auto=compress&cs=tinysrgb&w=1600" alt="明るいリビングでの家族の団欒" width="1600" height="1067" loading="lazy" />
        <figcaption class="cap bl">大切な人と、豊かな時間を。</figcaption>
      </figure>
      <div class="dots" id="heroDots" aria-hidden="true">
        <div class="dot on"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div>
      </div>
    </div>
  </div>

  <main>
    <section class="cta-wrap">
      <h1>なぜ学ぶのか、を決めよう。</h1>
      <p class="lead">AIとの対話で、最終目標と道筋を明確化。今日から動ける「最初の一歩」へ。</p>
      <a href="/dialog" id="startBtn" class="cta-btn">はじめる</a>

      <div class="cta-meta" aria-label="安心のポイント">
        <span class="badge">安全に配慮</span>
        <span class="badge">所要10〜15分</span>
        <span class="badge">いつでも中断OK</span>
      </div>
    </section>

    <!-- 90秒お試しミニ体験 -->
    <section class="mini" id="miniTry">
      <h2>まずは90秒でお試し</h2>
      <p>3つの質問に答えるだけで、会話の続きから<strong>/dialog</strong>に移動できます。</p>
      <div class="steps">
        <div class="step" data-step="1">
          <h3>1) 学ぶ理由は？</h3>
          <div class="chips" role="group" aria-label="学ぶ理由">
            <button class="chip" data-v="転職・収入UP">転職・収入UP</button>
            <button class="chip" data-v="好きな分野を極めたい">好きな分野を極めたい</button>
            <button class="chip" data-v="自信をつけたい">自信をつけたい</button>
          </div>
        </div>
        <div class="step" data-step="2">
          <h3>2) 気になる分野は？</h3>
          <div class="chips" role="group" aria-label="分野">
            <button class="chip" data-v="AI・プログラミング">AI・プログラミング</button>
            <button class="chip" data-v="デザイン・動画">デザイン・動画</button>
            <button class="chip" data-v="マーケ・営業">マーケ・営業</button>
          </div>
        </div>
        <div class="step" data-step="3">
          <h3>3) 使える時間は？</h3>
          <div class="chips" role="group" aria-label="時間">
            <button class="chip" data-v="毎日15分">毎日15分</button>
            <button class="chip" data-v="平日30〜60分">平日30〜60分</button>
            <button class="chip" data-v="週末まとまって">週末まとまって</button>
          </div>
        </div>
      </div>
      <div class="actions">
        <button id="miniSubmit" class="cta" type="button">ミッション草案を作る →</button>
      </div>
      <div class="note" id="miniNote">送信は3回だけ。返答は短文で返ってきます。</div>
    </section>

    <section class="why">
      <h2>なぜ『Mission Compass』は効く？</h2>
      <p class="sub">仕組みが背中を押す3つの理由</p>
      <div class="why-grid">
        <article class="why-card olive">
          <div class="why-ic">1</div>
          <h3 class="why-ttl">最初に“WHY”を固める</h3>
          <p class="why-txt">目的が明確になると、迷いが減り、行動が続く。</p>
          <span class="why-badge">ブレない軸</span>
        </article>
        <article class="why-card burnt">
          <div class="why-ic">2</div>
          <h3 class="why-ttl">AIメンターが毎日伴走</h3>
          <p class="why-txt">小さな詰まりをその場で解消。次の一手がすぐ決まる。</p>
          <span class="why-badge">つまずき即解決</span>
        </article>
        <article class="why-card purple">
          <div class="why-ic">3</div>
          <h3 class="why-ttl">今日の最初の一歩が決まる</h3>
          <p class="why-txt">目標を“最小行動”へ分解。1日1歩が確実に進む。</p>
          <span class="why-badge">行動まで分解</span>
        </article>
      </div>
    </section>
  </main>

  <footer>
    © 2025 Mission Compass
    <div class="build">build: 2025-10-15-lp-mini-try-1</div>
  </footer>

  <!-- Hero rotation -->
  <script>
    document.addEventListener('DOMContentLoaded', function(){
      const rotator = document.getElementById('heroRotator'); if(!rotator) return;
      const slides = rotator.querySelectorAll('.slide');
      const dotsWrap = document.getElementById('heroDots');
      const dots = dotsWrap ? dotsWrap.children : [];
      let i=0, ms=4500;
      function show(n){
        slides[i]?.classList.remove('on'); dots[i]?.classList.remove('on');
        i=(n+slides.length)%slides.length;
        slides[i]?.classList.add('on'); dots[i]?.classList.add('on');
      }
      setInterval(()=> show(i+1), ms);
    });
  </script>

  <!-- Firebase Auth（Google） -->
  <script type="module">
    import { firebaseConfig } from '/firebase-config.js';
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js';
    import {
      getAuth, GoogleAuthProvider, onAuthStateChanged,
      signInWithPopup, signOut
    } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js';

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    const userEl   = document.getElementById('user');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn= document.getElementById('logoutBtn');

    loginBtn?.addEventListener('click', async () => {
      loginBtn.disabled = true;
      try { await signInWithPopup(auth, provider); }
      catch(e){ console.error(e); }
      finally { loginBtn.disabled = false; }
    });
    logoutBtn?.addEventListener('click', async () => {
      logoutBtn.disabled = true;
      try { await signOut(auth); }
      catch(e){ console.error(e); }
      finally { logoutBtn.disabled = false; }
    });

    onAuthStateChanged(auth, (user)=>{
      if(user){
        userEl.hidden = false; logoutBtn.hidden = false; loginBtn.hidden = true;
        userEl.textContent = user.email || user.displayName || 'ログイン済み';
      }else{
        userEl.hidden = true; logoutBtn.hidden = true; loginBtn.hidden = false;
        userEl.textContent = '';
      }
    });

    // ===== 90秒お試しロジック =====
    const qs = [
      {key:'why',   text:(v)=>`ミニ体験: 学ぶ理由は「${v}」。1文で受け止めて、次の質問を出して。`},
      {key:'area',  text:(v)=>`ミニ体験: 気になる分野は「${v}」。1文で受け止めて、次の質問を出して。`},
      {key:'time',  text:(v)=>`ミニ体験: 使える時間は「${v}」。1文で受け止めて、次の質問を出して。`},
    ];

    const answers = { why:null, area:null, time:null };
    document.querySelectorAll('.chip').forEach(ch=>{
      ch.addEventListener('click', ()=>{
        const v = ch.dataset.v; const stepEl = ch.closest('.step'); if(!v || !stepEl) return;
        stepEl.querySelectorAll('.chip').forEach(b=> b.setAttribute('aria-pressed','false'));
        ch.setAttribute('aria-pressed','true');
        const stepIdx = +stepEl.dataset.step;
        if(stepIdx===1) answers.why = v;
        if(stepIdx===2) answers.area = v;
        if(stepIdx===3) answers.time = v;
      });
    });

    document.getElementById('miniSubmit')?.addEventListener('click', async ()=>{
      const note = document.getElementById('miniNote');
      if(!answers.why || !answers.area || !answers.time){
        note.textContent = '未選択があります。3つすべて選んでください。';
        return;
      }
      try{
        note.textContent = '送信中…（数秒）';

        // 部屋「課題」用の sessionId を生成し、localStorage にセット
        const sidKey = 'dlg_sid_issue';
        const stepKey = 'srv_step_issue';
        const msgsKey = 'msgs_issue';
        const roomKey = 'dlg_room';

        const sid = 'lp-' + (crypto?.randomUUID ? crypto.randomUUID() : (Date.now() + Math.random().toString(16).slice(2)));
        localStorage.setItem(sidKey, sid);
        localStorage.setItem(roomKey, 'issue');

        // 3ターンだけ /api/chat に投げる（軽い文脈づくり）
        const msgs = [];
        const post = async (text)=>{
          msgs.push({ who:'me', html: escapeHtml(text) });
          const res = await fetch('/api/chat', {
            method:'POST',
            headers:{ 'Content-Type':'application/json' },
            body: JSON.stringify({ message:text, sessionId: sid })
          });
          const data = await res.json();
          const reply = (data.reply || '').toString().trim() || '（返信を取得できませんでした）';
          msgs.push({ who:'ai', html: escapeHtml(reply) });
          if(typeof data.step==='number') localStorage.setItem(stepKey, String(data.step));
        };

        await post(qs[0].text(answers.why));
        await post(qs[1].text(answers.area));
        await post(qs[2].text(answers.time));

        // ミニ体験開始の案内を先頭に1つだけ足す
        msgs.unshift({ who:'ai', html:'<b>ミニ体験の続きから始めよう。</b> ここまでの回答を拾って、次の一手を一緒に詰めるよ。' });

        // 表示履歴（最大50件に制限）
        while(msgs.length>50) msgs.shift();
        localStorage.setItem(msgsKey, JSON.stringify(msgs));

        // /dialog へ遷移（部屋は「課題」が選ばれた状態になる）
        location.href = '/dialog';
      }catch(e){
        console.error(e);
        note.textContent = 'サーバ通信でエラーが発生しました。時間をおいて再度お試しください。';
      }
    });

    function escapeHtml(s){
      return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }
  </script>
</body>
</html>
